# Admin/Blade routes configuration
# Routes /admin/* and static assets to Laravel backend for HTML responses
# This is loaded after API config but before frontend config

# Admin panel routes (/admin/*)
location /admin {
    proxy_pass http://hostly-web-service:80;
    
    # Essential proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # CRITICAL: Pass cookies for session management
    proxy_set_header Cookie $http_cookie;
    proxy_cookie_path / /;
    proxy_cookie_domain off;
    
    # Timeouts for HTML pages
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings for HTML responses
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;
    
    # Don't cache HTML responses
    proxy_cache_bypass $http_upgrade;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    # Logging
    access_log /var/log/nginx/admin_access.log;
    error_log /var/log/nginx/admin_error.log;
}

# Laravel static assets (CSS, JS, images, fonts, storage)
# These are served by Laravel's public directory
location ~* ^/(css|js|images|fonts|storage)/ {
    proxy_pass http://hostly-web-service:80;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # Cache static assets aggressively
    proxy_cache_valid 200 1d;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Cache-Status $upstream_cache_status;
    
    # Logging (minimal for static assets)
    access_log off;
}

